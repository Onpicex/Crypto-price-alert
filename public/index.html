<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Price Alert - ä»·æ ¼ç›‘æ§</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; }
    
    .header { background: #1a1a2e; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 1.25rem; }
    .header .status { font-size: 0.75rem; color: #4ade80; }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.85rem; color: #9ca3af; }
    .user-info .role { background: #4f46e5; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 8px; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    
    .card { background: white; border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .card h2 { font-size: 1rem; margin-bottom: 1rem; color: #1a1a2e; }
    .card h3 { font-size: 0.9rem; margin-bottom: 0.75rem; color: #374151; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.5rem; }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: 0.875rem; margin-bottom: 0.375rem; color: #666; }
    .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #4f46e5; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem; transition: opacity 0.2s; }
    .btn:hover { opacity: 0.9; }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    .btn-warning { background: #f59e0b; color: white; }
    
    .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #f3f4f6; }
    .alert-item:last-child { border-bottom: none; }
    .alert-info { flex: 1; }
    .alert-symbol { font-weight: 600; color: #1a1a2e; }
    .alert-condition { font-size: 0.8rem; color: #6b7280; }
    .alert-actions { display: flex; gap: 0.5rem; }
    
    .badge { display: inline-block; padding: 0.125rem 0.375rem; border-radius: 9999px; font-size: 0.7rem; margin-left: 0.5rem; }
    .badge-enabled { background: #d1fae5; color: #065f46; }
    .badge-disabled { background: #f3f4f6; color: #6b7280; }
    
    .nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .nav-btn { padding: 0.5rem 1rem; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
    .nav-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #f3f4f6; }
    th { background: #f9fafb; font-weight: 600; color: #374151; }
    .status-success { color: #10b981; }
    .status-failed { color: #ef4444; }
    .status-pending { color: #f59e0b; }
    
    .login-page { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
    .login-box { background: white; padding: 2rem; border-radius: 8px; width: 100%; max-width: 360px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .login-box h2 { text-align: center; margin-bottom: 1.5rem; }
    .login-tabs { display: flex; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; }
    .login-tab { flex: 1; padding: 0.5rem; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; }
    .login-tab.active { border-bottom-color: #4f46e5; color: #4f46e5; }
    
    .hidden { display: none !important; }
    
    .toast { position: fixed; bottom: 1rem; right: 1rem; background: #1a1a2e; color: white; padding: 0.75rem 1rem; border-radius: 4px; font-size: 0.875rem; z-index: 1000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    .empty-state { text-align: center; padding: 2rem; color: #9ca3af; }
    
    .user-table td { vertical-align: middle; }
    .user-table .role-admin { color: #f59e0b; font-weight: 600; }
    .user-table .role-user { color: #6b7280; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”” Price Alert</h1>
    <div class="header-right">
      <span class="status" id="engineStatus">å¼•æ“è¿è¡Œä¸­</span>
      <span class="user-info hidden" id="userInfo">
        <span id="currentUsername"></span>
        <span class="role" id="currentRole"></span>
      </span>
      <button class="btn btn-secondary btn-sm hidden" id="logoutBtn" onclick="logout()">é€€å‡º</button>
    </div>
  </div>
  
  <!-- Login Page -->
  <div id="loginPage" class="container login-page hidden">
    <div class="login-box">
      <h2>ğŸ” ç™»å½•</h2>
      
      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm">
        <div class="form-group">
          <label>ç”¨æˆ·å</label>
          <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å">
        </div>
        <div class="form-group">
          <label>å¯†ç </label>
          <input type="password" id="loginPassword" placeholder="å¯†ç ">
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="doLogin()">ç™»å½•</button>
      </div>
      
      <p style="text-align: center; margin-top: 1rem; font-size: 0.8rem; color: #6b7280;">
        æ³¨å†Œå·²ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·
      </p>
    </div>
  </div>
  
  <!-- Main App -->
  <div id="mainApp" class="container hidden">
    <div class="nav">
      <button class="nav-btn active" onclick="showTab('dashboard')">æ¦‚è§ˆ</button>
      <button class="nav-btn" onclick="showTab('alerts')">ç›‘æ§è§„åˆ™</button>
      <button class="nav-btn" onclick="showTab('events')">è§¦å‘æ—¥å¿—</button>
      <button class="nav-btn" onclick="showTab('settings')">ç³»ç»Ÿè®¾ç½®</button>
      <button class="nav-btn" onclick="showTab('help')">å¸®åŠ©</button>
      <button class="nav-btn hidden" id="adminUsersBtn" onclick="showTab('users')">ç”¨æˆ·ç®¡ç†</button>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="hidden">
      <div class="card">
        <h2>ğŸ“Š æ¦‚è§ˆ</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #4f46e5;" id="dashAlerts">0</div>
            <div style="font-size: 0.85rem; color: #6b7280;">ç›‘æ§è§„åˆ™</div>
          </div>
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="dashEnabled">0</div>
            <div style="font-size: 0.85rem; color: #6b7280;">å·²å¯ç”¨</div>
          </div>
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="dashEvents">0</div>
            <div style="font-size: 0.85rem; color: #6b7280;">è§¦å‘è®°å½•</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
          <button class="btn btn-primary" onclick="showTab('alerts');document.getElementById('alertForm').scrollIntoView({behavior: 'smooth'})">â• æ–°å»ºè§„åˆ™</button>
          <button class="btn btn-secondary" onclick="loadEvents(); showTab('events')">ğŸ“œ æŸ¥çœ‹æ—¥å¿—</button>
          <button class="btn btn-secondary" onclick="showTab('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
        </div>
      </div>
      
      <div class="card">
        <h2>ğŸ“‹ å·²é…ç½®çš„è§„åˆ™</h2>
        <div id="dashboardAlertsList"></div>
      </div>
    </div>
    
    <!-- Alerts Tab -->
    <div id="alertsTab">
      <div class="card">
        <h2>â• æ–°å»ºè§„åˆ™</h2>
        <form id="alertForm" onsubmit="createAlert(event)">
          <div class="form-row">
            <div class="form-group">
              <label>äº¤æ˜“å¯¹</label>
              <input type="text" name="symbol" placeholder="BTCUSDT" required style="text-transform: uppercase;">
            </div>
            <div class="form-group">
              <label>æ¡ä»¶ç±»å‹</label>
              <select name="condition_type" required>
                <option value="cross_up">ä¸Šç©¿ (cross_up)</option>
                <option value="cross_down">ä¸‹ç©¿ (cross_down)</option>
                <option value="price_gte">ä»·æ ¼ â‰¥</option>
                <option value="price_lte">ä»·æ ¼ â‰¤</option>
                <option value="pct_change_up">æ¶¨å¹… â‰¥ (%)</option>
                <option value="pct_change_down">è·Œå¹… â‰¥ (%)</option>
              </select>
            </div>
            <div class="form-group">
              <label>é˜ˆå€¼</label>
              <input type="number" name="threshold" placeholder="52000" step="any" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>è½®è¯¢é—´éš” (ç§’) â±ï¸ å¤šå°‘ç§’è·å–ä¸€æ¬¡ä»·æ ¼</label>
              <input type="number" name="poll_interval_sec" value="60" min="1" max="3600" required>
            </div>
            <div class="form-group">
              <label>å†·å´æ—¶é—´ (ç§’) â° è§¦å‘åå¤šä¹…å†…ä¸å†è§¦å‘</label>
              <input type="number" name="cooldown_sec" value="300" min="0" required>
            </div>
            <div class="form-group">
              <label>æé†’æ¬¡æ•° ğŸ”” è§¦å‘åå‘é€å‡ æ¬¡é€šçŸ¥ (1-10)</label>
              <input type="number" name="notify_times" value="1" min="1" max="10" required>
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" name="is_enabled" checked> å¯ç”¨
              </label>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">åˆ›å»ºè§„åˆ™</button>
        </form>
      </div>
      
      <div class="card">
        <h2>ğŸ“‹ è§„åˆ™åˆ—è¡¨</h2>
        <div id="alertsList"></div>
      </div>
    </div>
    
    <!-- Events Tab -->
    <div id="eventsTab" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2>ğŸ“œ è§¦å‘æ—¥å¿—</h2>
          <div>
            <input type="text" id="eventSymbolFilter" placeholder="ç­›é€‰äº¤æ˜“å¯¹" style="padding: 0.25rem 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            <button class="btn btn-secondary btn-sm" onclick="loadEvents()">åˆ·æ–°</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table id="eventsTable">
            <thead>
              <tr>
                <th>æ—¶é—´</th>
                <th>ç±»å‹</th>
                <th>åŸå› </th>
                <th>ä»·æ ¼</th>
                <th>é˜ˆå€¼</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settingsTab" class="hidden">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2>âš™ï¸ Telegram é…ç½®</h2>
          <span id="telegramStatus" style="font-size: 0.8rem; padding: 4px 12px; border-radius: 12px; background: #f3f4f6; color: #6b7280;">æœªé…ç½®</span>
        </div>
        <p style="font-size: 0.8rem; color: #6b7280; margin-bottom: 1rem;">æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹é…ç½®ï¼Œä»…è‡ªå·±æ”¶åˆ°é€šçŸ¥</p>
        
        <!-- å·²é…ç½®çš„ Telegram æ˜¾ç¤º -->
        <div id="telegramInfo" class="hidden" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 600; color: #166534;">âœ… å·²é…ç½®çš„ Telegram</div>
            <button class="btn btn-danger btn-sm" onclick="deleteTelegramConfig()">åˆ é™¤é…ç½®</button>
          </div>
          <div style="font-size: 0.85rem; color: #374151; margin-top: 0.5rem;">
            <div style="margin-bottom: 0.25rem;">
              <span style="color: #6b7280;">Botï¼š</span>
              <span id="configuredBotToken" style="font-weight: 600;"></span>
            </div>
            <div>
              <span style="color: #6b7280;">Chat IDï¼š</span>
              <span id="configuredChatId" style="font-weight: 600;"></span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Bot Token</label>
          <input type="text" id="telegramBotToken" placeholder="ä» @BotFather è·å–">
        </div>
        <div class="form-group">
          <label>Chat ID</label>
          <input type="text" id="telegramChatId" placeholder="ç”¨æˆ· ID æˆ– ç¾¤ç»„ ID">
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-primary" onclick="saveTelegramSettings()">ä¿å­˜</button>
          <button class="btn btn-success" onclick="testTelegram()">æµ‹è¯•</button>
        </div>
      </div>
      
      <div class="card">
        <h2>ğŸ”’ ä¿®æ”¹å¯†ç </h2>
        <div class="form-group">
          <label>å½“å‰å¯†ç </label>
          <input type="password" id="oldPassword" placeholder="å½“å‰å¯†ç ">
        </div>
        <div class="form-group">
          <label>æ–°å¯†ç  (è‡³å°‘6ä½)</label>
          <input type="password" id="newPassword" placeholder="æ–°å¯†ç ">
        </div>
        <button class="btn btn-primary" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
      </div>
    </div>
    
    <!-- Help Tab -->
    <div id="helpTab" class="hidden">
      <div class="card">
        <h2>ğŸ“– ä½¿ç”¨å¸®åŠ©</h2>
        
        <h3 style="margin: 1rem 0 0.5rem;">ä¸€ã€å¦‚ä½•åˆ›å»º Telegram Bot</h3>
        <ol style="margin-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
          <li>åœ¨ Telegram æœç´¢ <b>@BotFather</b></li>
          <li>å‘é€å‘½ä»¤ <code>/newbot</code></li>
          <li>æŒ‰ç…§æç¤ºè¾“å…¥ Bot åç§°ï¼ˆå¦‚ï¼šä»·æ ¼ç›‘æ§æœºå™¨äººï¼‰</li>
          <li>è®¾ç½®ç”¨æˆ·åï¼ˆå¿…é¡»ä»¥ bot ç»“å°¾ï¼Œå¦‚ <code>PriceAlertBot</code>ï¼‰</li>
          <li>åˆ›å»ºæˆåŠŸåï¼ŒBotFather ä¼šç»™ä½ ä¸€ä¸ª <b>Bot Token</b>ï¼Œå¤åˆ¶ä¿å­˜å¥½</li>
        </ol>
        
        <h3 style="margin: 1rem 0 0.5rem;">äºŒã€å¦‚ä½•è·å– Bot Token</h3>
        <ol style="margin-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
          <li>ä¸ <b>@BotFather</b> å¯¹è¯</li>
          <li>å‘é€ <code>/mybots</code></li>
          <li>é€‰æ‹©ä½ çš„ Bot</li>
          <li>ç‚¹å‡» <b>API Token</b></li>
          <li>å°±å¯ä»¥çœ‹åˆ°æˆ–é‡æ–°ç”Ÿæˆ Bot Token</li>
        </ol>
        
        <h3 style="margin: 1rem 0 0.5rem;">ä¸‰ã€å¦‚ä½•è·å– Chat ID</h3>
        <ol style="margin-left: 1.5rem; font-size: 0.9rem; line-height: 1.8;">
          <li><b>æ–¹æ³•1 - ç§èŠè·å–ï¼š</b>
            <ul style="margin-left: 1rem;">
              <li>åœ¨ Telegram æœç´¢ <b>@userinfobot</b> æˆ– <b>@getidsbot</b></li>
              <li>å‘é€ <code>/start</code></li>
              <li>æœºå™¨äººä¼šæ˜¾ç¤ºä½ çš„æ•°å­— IDï¼ˆå¦‚ <code>6087032704</code>ï¼‰</li>
            </ul>
          </li>
          <li><b>æ–¹æ³•2 - ç§èŠä½ çš„ Botï¼š</b>
            <ul style="margin-left: 1rem;">
              <li>ä¸åˆšåˆ›å»ºçš„ Bot å‘èµ·ç§èŠ</li>
              <li>å‘é€ <code>/start</code></li>
              <li>åœ¨ç¾¤é‡Œå‘æ¶ˆæ¯è®© Bot çœ‹åˆ°ï¼Œç„¶åæŸ¥è¯¢</ul>
          </li>
            </li>
        </ol>
        
        <h3 style="margin: 1rem 0 0.5rem;">å››ã€é…ç½®ç¤ºä¾‹</h3>
        <div style="background: #f3f4f6; padding: 1rem; border-radius: 4px; font-size: 0.85rem;">
          <p><b>Bot Token æ ¼å¼ï¼š</b> <code>1234567890:ABCdefGHIjklMNOpqrsTUVwxyz</code></p>
          <p><b>Chat ID æ ¼å¼ï¼š</b> <code>1234567890</code>ï¼ˆçº¯æ•°å­—ï¼‰æˆ– <code>-1001234567890</code>ï¼ˆç¾¤ç»„ï¼‰</p>
        </div>
      </div>
    </div>
    
    <!-- Users Tab (Admin Only) -->
    <div id="usersTab" class="hidden">
      <div class="card">
        <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
        <div class="form-row" style="margin-bottom: 1rem;">
          <div class="form-group">
            <label>æ–°ç”¨æˆ·å</label>
            <input type="text" id="newUsername" placeholder="ç”¨æˆ·å">
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="newUserPassword" placeholder="å¯†ç ">
          </div>
          <div class="form-group">
            <label>è§’è‰²</label>
            <select id="newUserRole">
              <option value="user">æ™®é€šç”¨æˆ·</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
          </div>
          <div class="form-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="createUser()">åˆ›å»ºç”¨æˆ·</button>
          </div>
        </div>
        
        <table class="user-table">
          <thead>
            <tr>
              <th>ç”¨æˆ·å</th>
              <th>è§’è‰²</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="usersList"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast hidden"></div>
  
  <script>
    let token = localStorage.getItem('priceAlertToken');
    let currentUser = null;
    const API_BASE = '';
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAuth() {
      if (!token) {
        showLogin();
        return;
      }
      
      try {
        const userData = await apiCall('/api/me');
        currentUser = userData;
        showApp();
        loadAlerts();
        loadSettings();
      } catch {
        token = null;
        localStorage.removeItem('priceAlertToken');
        showLogin();
      }
    }
    
    async function apiCall(path, options = {}) {
      const response = await fetch(API_BASE + path, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        }
      });
      
      if (response.status === 401) {
        token = null;
        localStorage.removeItem('priceAlertToken');
        showLogin();
        throw new Error('Unauthorized');
      }
      
      return response.json();
    }
    
    function showLogin() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }
    
    function showApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
      
      // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
      document.getElementById('currentUsername').textContent = currentUser.username;
      document.getElementById('currentRole').textContent = currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
      
      // ç®¡ç†å‘˜æ˜¾ç¤ºç”¨æˆ·ç®¡ç†æŒ‰é’®
      if (currentUser.role === 'admin') {
        document.getElementById('adminUsersBtn').classList.remove('hidden');
      }
      
      // é»˜è®¤æ˜¾ç¤ºæ¦‚è§ˆ
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.nav-btn').classList.add('active');
      
      document.getElementById('dashboardTab').classList.remove('hidden');
      document.getElementById('alertsTab').classList.add('hidden');
      document.getElementById('eventsTab').classList.add('hidden');
      document.getElementById('settingsTab').classList.add('hidden');
      document.getElementById('helpTab').classList.add('hidden');
      document.getElementById('usersTab').classList.add('hidden');
      
      loadDashboard();
    }
    
    async function doLogin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      if (!username || !password) return;
      
      const result = await fetch(API_BASE + '/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      }).then(r => r.json());
      
      if (result.success) {
        token = result.token;
        currentUser = result.user;
        localStorage.setItem('priceAlertToken', token);
        showApp();
        loadAlerts();
        loadSettings();
      } else {
        showToast(result.error || 'ç™»å½•å¤±è´¥');
      }
    }
    
    function logout() {
      token = null;
      currentUser = null;
      localStorage.removeItem('priceAlertToken');
      showLogin();
    }
    
    function showTab(tab) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('dashboardTab').classList.add('hidden');
      document.getElementById('alertsTab').classList.add('hidden');
      document.getElementById('eventsTab').classList.add('hidden');
      document.getElementById('settingsTab').classList.add('hidden');
      document.getElementById('helpTab').classList.add('hidden');
      document.getElementById('usersTab').classList.add('hidden');
      document.getElementById(tab + 'Tab').classList.remove('hidden');
      
      if (tab === 'dashboard') loadDashboard();
      if (tab === 'events') loadEvents();
      if (tab === 'settings') loadSettings();
      if (tab === 'users' && currentUser.role === 'admin') loadUsers();
    }
    
    // Dashboard
    async function loadDashboard() {
      const alerts = await apiCall('/api/alerts');
      const events = await apiCall('/api/events?limit=100');
      
      const total = alerts.length;
      const enabled = alerts.filter(a => a.is_enabled).length;
      
      document.getElementById('dashAlerts').textContent = total;
      document.getElementById('dashEnabled').textContent = enabled;
      document.getElementById('dashEvents').textContent = events.length;
      
      // æ˜¾ç¤ºè§„åˆ™åˆ—è¡¨
      const container = document.getElementById('dashboardAlertsList');
      if (!alerts.length) {
        container.innerHTML = '<div class="empty-state">æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»"æ–°å»ºè§„åˆ™"åˆ›å»º</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <div class="alert-info">
            <span class="alert-symbol">${alert.symbol}</span>
            <span class="badge ${alert.is_enabled ? 'badge-enabled' : 'badge-disabled'}">
              ${alert.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
            </span>
            <div class="alert-condition">
              ${alert.condition_type} | é˜ˆå€¼: ${alert.threshold} | é—´éš”: ${alert.poll_interval_sec}ç§’
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Alerts
    async function loadAlerts() {
      const alerts = await apiCall('/api/alerts');
      const container = document.getElementById('alertsList');
      
      if (!alerts.length) {
        container.innerHTML = '<div class="empty-state">æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»ä¸Šæ–¹åˆ›å»º</div>';
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-item">
          <div class="alert-info">
            <span class="alert-symbol">${alert.symbol}</span>
            <span class="badge ${alert.is_enabled ? 'badge-enabled' : 'badge-disabled'}">
              ${alert.is_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
            </span>
            <div class="alert-condition">
              ${alert.condition_type} | é˜ˆå€¼: ${alert.threshold} | é—´éš”: ${alert.poll_interval_sec}ç§’ | å†·å´: ${alert.cooldown_sec}ç§’ | æé†’: ${alert.notify_times || 1}æ¬¡
            </div>
          </div>
          <div class="alert-actions">
            <button class="btn btn-secondary btn-sm" onclick="testAlert('${alert.id}')">æµ‹è¯•</button>
            <button class="btn btn-${alert.is_enabled ? 'secondary' : 'success'} btn-sm" onclick="toggleAlert('${alert.id}', ${!alert.is_enabled})">
              ${alert.is_enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteAlert('${alert.id}')">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }
    
    async function createAlert(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        symbol: form.symbol.value.toUpperCase(),
        condition_type: form.condition_type.value,
        threshold: parseFloat(form.threshold.value),
        poll_interval_sec: parseInt(form.poll_interval_sec.value),
        cooldown_sec: parseInt(form.cooldown_sec.value),
        notify_times: parseInt(form.notify_times.value) || 1,
        is_enabled: form.is_enabled.checked
      };
      
      const result = await apiCall('/api/alerts', {
        method: 'POST',
        body: JSON.stringify(data)
      });
      
      if (result.id) {
        showToast('è§„åˆ™åˆ›å»ºæˆåŠŸ');
        form.reset();
        loadAlerts();
      } else {
        showToast(result.error || 'åˆ›å»ºå¤±è´¥');
      }
    }
    
    async function toggleAlert(id, isEnabled) {
      await apiCall(`/api/alerts/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ is_enabled: isEnabled })
      });
      loadAlerts();
    }
    
    async function deleteAlert(id) {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      await apiCall(`/api/alerts/${id}`, { method: 'DELETE' });
      loadAlerts();
    }
    
    async function testAlert(id) {
      const result = await apiCall(`/api/alerts/${id}/test`, { method: 'POST' });
      showToast(result.success ? 'æµ‹è¯•æ¶ˆæ¯å·²å‘é€' : (result.error || 'å‘é€å¤±è´¥'));
    }
    
    // Events
    async function loadEvents() {
      const symbol = document.getElementById('eventSymbolFilter').value;
      const events = await apiCall('/api/events' + (symbol ? `?symbol=${symbol}` : ''));
      const tbody = document.querySelector('#eventsTable tbody');
      
      if (!events.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— æ—¥å¿—</td></tr>';
        return;
      }
      
      tbody.innerHTML = events.map(e => `
        <tr>
          <td>${new Date(e.triggered_at * 1000).toLocaleString('zh-CN')}</td>
          <td>${e.event_type}</td>
          <td>${e.reason || '-'}</td>
          <td>${e.price ? e.price.toLocaleString() : '-'}</td>
          <td>${e.threshold ? e.threshold.toLocaleString() : '-'}</td>
          <td class="status-${e.notify_status}">${e.notify_status}</td>
        </tr>
      `).join('');
    }
    
    // Settings
    async function loadSettings() {
      const settings = await apiCall('/api/settings');
      document.getElementById('telegramChatId').value = settings.telegram?.chat_id || '';
      document.getElementById('telegramBotToken').value = '';
      
      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      const statusEl = document.getElementById('telegramStatus');
      const infoEl = document.getElementById('telegramInfo');
      
      if (settings.telegram?.configured) {
        statusEl.textContent = 'âœ… å·²é…ç½®';
        statusEl.style.background = '#d1fae5';
        statusEl.style.color = '#065f46';
        
        // æ˜¾ç¤ºå·²é…ç½®çš„ Telegram ä¿¡æ¯
        infoEl.classList.remove('hidden');
        const botToken = settings.telegram.bot_token || '';
        const chatId = settings.telegram.chat_id || '';
        
        // è·å– bot ç”¨æˆ·å
        try {
          const botInfo = await fetch(`https://api.telegram.org/bot${botToken}/getMe`).then(r => r.json());
          const botUsername = botInfo.result?.username ? '@' + botInfo.result.username : 'Bot';
          document.getElementById('configuredBotToken').textContent = botUsername;
        } catch {
          document.getElementById('configuredBotToken').textContent = 'Bot';
        }
        
        document.getElementById('configuredChatId').textContent = chatId;
      } else {
        statusEl.textContent = 'âŒ æœªé…ç½®';
        statusEl.style.background = '#fee2e2';
        statusEl.style.color = '#991b1b';
        infoEl.classList.add('hidden');
      }
    }
    
    async function deleteTelegramConfig() {
      if (!confirm('ç¡®å®šåˆ é™¤ Telegram é…ç½®ï¼Ÿ')) return;
      
      const result = await apiCall('/api/settings/telegram', { method: 'DELETE' });
      if (result.success) {
        showToast('é…ç½®å·²åˆ é™¤');
        loadSettings();
      } else {
        showToast(result.error || 'åˆ é™¤å¤±è´¥');
      }
    }
    
    async function saveTelegramSettings() {
      const bot_token = document.getElementById('telegramBotToken').value;
      const chat_id = document.getElementById('telegramChatId').value;
      
      await apiCall('/api/settings', {
        method: 'PUT',
        body: JSON.stringify({ telegram: { bot_token, chat_id } })
      });
      
      showToast('ä¿å­˜æˆåŠŸ');
    }
    
    async function changePassword() {
      const old_password = document.getElementById('oldPassword').value;
      const new_password = document.getElementById('newPassword').value;
      
      if (!old_password || !new_password) {
        showToast('è¯·å¡«å†™å½“å‰å¯†ç å’Œæ–°å¯†ç ');
        return;
      }
      
      const result = await apiCall('/api/settings/password', {
        method: 'POST',
        body: JSON.stringify({ old_password, new_password })
      });
      
      if (result.success) {
        showToast('å¯†ç ä¿®æ”¹æˆåŠŸ');
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
      } else {
        showToast(result.error || 'ä¿®æ”¹å¤±è´¥');
      }
    }
    
    async function testTelegram() {
      const bot_token = document.getElementById('telegramBotToken').value;
      const chat_id = document.getElementById('telegramChatId').value;
      
      if (!bot_token || !chat_id) {
        showToast('è¯·å…ˆå¡«å†™ Bot Token å’Œ Chat ID');
        return;
      }
      
      const result = await apiCall('/api/settings/telegram/test', {
        method: 'POST',
        body: JSON.stringify({ bot_token, chat_id })
      });
      
      showToast(result.success ? 'æµ‹è¯•æ¶ˆæ¯å·²å‘é€' : (result.error || 'å‘é€å¤±è´¥'));
    }
    
    // Users (Admin)
    async function loadUsers() {
      const users = await apiCall('/api/admin/users');
      const tbody = document.getElementById('usersList');
      
      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${u.username}</td>
          <td class="role-${u.role}">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}</td>
          <td>${new Date(u.created_at * 1000).toLocaleString('zh-CN')}</td>
          <td>
            ${u.role !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">åˆ é™¤</button>` : '-'}
          </td>
        </tr>
      `).join('');
    }
    
    async function createUser() {
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;
      
      if (!username || !password) {
        showToast('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
        return;
      }
      
      const result = await apiCall('/api/admin/users', {
        method: 'POST',
        body: JSON.stringify({ username, password, role })
      });
      
      if (result.id) {
        showToast('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
        document.getElementById('newUsername').value = '';
        document.getElementById('newUserPassword').value = '';
        loadUsers();
      } else {
        showToast(result.error || 'åˆ›å»ºå¤±è´¥');
      }
    }
    
    async function deleteUser(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿå…¶æ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤')) return;
      
      const result = await apiCall(`/api/admin/users/${id}`, { method: 'DELETE' });
      if (result.success) {
        showToast('ç”¨æˆ·å·²åˆ é™¤');
        loadUsers();
      } else {
        showToast(result.error || 'åˆ é™¤å¤±è´¥');
      }
    }
    
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    
    // Init
    checkAuth();
  </script>
</body>
</html>
